NB!! for using mysql8.0 see:https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password-compatible-connectors
ALTER USER 'alex'@'localhost' IDENTIFIED WITH mysql_native_password BY 'adrouk1546';
ALTER USER 'root'@'localhost'
  IDENTIFIED WITH mysql_native_password
  BY 'adrouk1546';
  
CREATE DATABASE poetry CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
for server:
CREATE DATABASE poetry CHARACTER SET utf8 COLLATE utf8_general_ci;


c
on server:
CREATE TABLE IF NOT EXISTS biblio (
    biblio_id INT AUTO_INCREMENT PRIMARY KEY,
    author VARCHAR(100) DEFAULT NULL,
    book_name VARCHAR(255),
    translator  VARCHAR(100) DEFAULT NULL,
    ref_name VARCHAR(255),
    seria VARCHAR(150),
    publisher VARCHAR(150),
    year YEAR,
    code VARCHAR(25) UNIQUE,
    isbn VARCHAR(20) UNIQUE DEFAULT NULL,
    present TINYINT NOT NULL,
    biblio_name TEXT NOT NULL 
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE utf8_general_ci;

CREATE TABLE IF NOT EXISTS biblio (
    biblio_id INT AUTO_INCREMENT PRIMARY KEY,
    author VARCHAR(100) DEFAULT NULL,
    book_name VARCHAR(255),
    translator  VARCHAR(100) DEFAULT NULL,
    ref_name VARCHAR(255),
    seria VARCHAR(150),
    publisher VARCHAR(150),
    year YEAR,
    code VARCHAR(25) UNIQUE,
    isbn VARCHAR(20) UNIQUE DEFAULT NULL,
    present TINYINT NOT NULL,
    biblio_name TEXT NOT NULL 
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;

#NB! insert using sourcesForDb.sql

CREATE FULLTEXT INDEX index_biblio 
ON biblio (author,
    book_name,
    translator,
    ref_name,
    seria,
    publisher,
    code,
    biblio_name
);

CREATE TABLE IF NOT EXISTS topics (
    topics_id INT AUTO_INCREMENT PRIMARY KEY,
    topic_name VARCHAR(150) UNIQUE NOT NULL,
    topic_synonym  VARCHAR(150)  DEFAULT NULL,
    present TINYINT NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS authors (
    author_id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(150) UNIQUE NOT NULL,
    proper_name  VARCHAR(150) NOT NULL,
    dates  VARCHAR(150)  NOT NULL,
    epoch  VARCHAR(150)  NOT NULL,
    present TINYINT NOT NULL,
    doc_text MEDIUMTEXT
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;

fort server:
CREATE TABLE IF NOT EXISTS authors (
    author_id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(150) UNIQUE NOT NULL,
    proper_name  VARCHAR(150) NOT NULL,
    dates  VARCHAR(150)  NOT NULL,
    epoch  VARCHAR(150)  NOT NULL,
    present TINYINT NOT NULL,
    doc_text MEDIUMTEXT
)) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE utf8_general_ci;

CREATE FULLTEXT INDEX index_authors
ON authors (
    full_name,
    proper_name,
    dates,
    epoch
);

UPDATE `authors` 
   SET `epoch` = TRIM(BOTH '"' FROM `epoch`);



drop index index_authors on  authors;

for server
CREATE TABLE IF NOT EXISTS authors_docs (
    author_id INT  PRIMARY KEY,
    doc_text text
) ENGINE=MyISAM DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;

LOAD DATA
    INFILE '/var/www/html/sql/author_docs.sql'
    INTO TABLE authors_docs
	FIELDS TERMINATED BY '#!#'
    ENCLOSED BY '^'
    LINES TERMINATED BY '##!!##'
;
for server
LOAD DATA   LOCAL  INFILE '~/author_docs.sql'     INTO TABLE authors_docs CHARACTER SET utf8mb4 FIELDS TERMINATED BY '#!#'     ENCLOSED BY '^'     LINES TERMINATED BY '##!!##';

ALTER TABLE authors
ADD doc_text text;

UPDATE authors a, authors_docs d SET a.doc_text = d.doc_text 
WHERE a.author_id = d.author_id;

select a.doc_text, d.doc_text
from authors a
join  authors_docs d on a.author_id = d.author_id;

truncate table authors_docs;

`full_name`, `lit_name`, `real_name`, `first_name`, `father_name`, `pseudonyms`, `born`, `born_place`, `died`, `died_place`, `present` 
CREATE TABLE IF NOT EXISTS translators (
    translator_id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(100) UNIQUE NOT NULL,
    lit_name VARCHAR(100) DEFAULT NULL,
    real_name VARCHAR(100)  NOT NULL,
    first_name  VARCHAR(100) DEFAULT NULL,
    father_name  VARCHAR(100) DEFAULT NULL,
    pseudonyms  VARCHAR(200) DEFAULT NULL,
    born  VARCHAR(20) DEFAULT NULL,
    born_place  VARCHAR(200) DEFAULT NULL,
    died  VARCHAR(20) DEFAULT NULL,
    died_place  VARCHAR(200) DEFAULT NULL,
    present TINYINT NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;
for server:
CREATE TABLE IF NOT EXISTS translators (
    translator_id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(100) UNIQUE NOT NULL,
    lit_name VARCHAR(100) DEFAULT NULL,
    real_name VARCHAR(100) NOT NULL,
    first_name  VARCHAR(100) DEFAULT NULL,
    father_name  VARCHAR(100) DEFAULT NULL,
    pseudonyms  VARCHAR(200) DEFAULT NULL,
    born  VARCHAR(20) DEFAULT NULL,
    born_place  VARCHAR(200) DEFAULT NULL,
    died  VARCHAR(20) DEFAULT NULL,
    died_place  VARCHAR(200) DEFAULT NULL,
    present TINYINT NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE utf8_general_ci;

CREATE TABLE IF NOT EXISTS authors (
    author_id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(150) UNIQUE NOT NULL,
    proper_name  VARCHAR(150) NOT NULL,
    dates  VARCHAR(150)  NOT NULL,
    epoch  VARCHAR(150) NOT NULL,
    present TINYINT NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS originals_tmp (
--    originals_id INT AUTO_INCREMENT PRIMARY KEY,
    author VARCHAR(150) NOT NULL,
    poem_name_zh  VARCHAR(255) NOT NULL,
    poem_name_ru  VARCHAR(255) NOT NULL,
    poem_code  VARCHAR(50) DEFAULT NULL,
    biblio_id  INT  DEFAULT NULL,
    poem_text TEXT NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE utf8_general_ci;


LOAD DATA  INFILE '/Users/alex/site/sql/originals1.sql' 
INTO TABLE originals_tmp CHARACTER SET utf8mb4 
FIELDS TERMINATED BY '#!#'     
ENCLOSED BY '^'     
LINES TERMINATED BY '##!!##';

UPDATE originals_tmp
SET author = REPLACE(author,'^','');
UPDATE `originals_tmp` 
   SET `author` = TRIM(BOTH ' ' FROM `author`);

ALTER TABLE originals_tmp 
ADD column author_id INT NOT NULL FIRST;
ALTER TABLE originals_tmp 
ADD column originals_id INT AUTO_INCREMENT PRIMARY KEY FIRST;
UPDATE `originals_tmp` 
SET author = SUBSTR(author,2)  where originals_id !=1;
delete from originals_tmp where originals_id=126;
UPDATE originals_tmp t
INNER JOIN authors a ON  a.full_name = t.author
SET t.author_id = a.author_id;
select * from originals_tmp where author_id =0;
UPDATE originals_tmp t
SET t.author_id = 15 where author = 'ВАН ВЭЙ (699-759)';
ALTER TABLE originals_tmp 
DROP COLUMN author;
update authors
set full_name = 'ВАН ВЭЙ (699-759)' where author_id =15;
update authors
set dates = '(699-759)' where author_id =15;

ALTER TABLE originals_tmp 
ADD column cycle_zh VARCHAR(255) DEFAULT NULL AFTER author_id;
ALTER TABLE originals_tmp 
ADD column cycle_ru VARCHAR(255) DEFAULT NULL AFTER cycle_zh;
ALTER TABLE originals_tmp 
ADD column subcycle_zh VARCHAR(255) DEFAULT NULL AFTER cycle_ru;
ALTER TABLE originals_tmp 
ADD column subcycle_ru VARCHAR(255) DEFAULT NULL AFTER subcycle_zh;

rename table originals_tmp to originals;

#poems
CREATE TABLE IF NOT EXISTS poems_tmp (
    -- poems_id INT AUTO_INCREMENT PRIMARY KEY,
    author VARCHAR(200) NOT NULL,
    translator1_id INT DEFAULT NULL,
    translator2_id INT DEFAULT NULL,
    translator3_id INT DEFAULT NULL,
    topic1_id INT DEFAULT NULL,
    topic2_id INT DEFAULT NULL,
    topic3_id INT DEFAULT NULL,
    topic4_id INT DEFAULT NULL,
    topic5_id INT DEFAULT NULL,
    poem_name_zh VARCHAR(100)  DEFAULT NULL,
    poem_name_ru  TEXT NOT NULL,
    poem_code VARCHAR(12)  DEFAULT NULL,
    biblio_id INT  DEFAULT NULL,
    poem_text MEDIUMTEXT
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;


LOAD DATA
    INFILE '/Users/alex/site/sql/poems.sql'
    INTO TABLE poems_tmp
	FIELDS TERMINATED BY '#!#'
    OPTIONALLY ENCLOSED BY '^'
    LINES TERMINATED BY '##!!##';
    
ALTER TABLE poems_tmp 
ADD column author_id INT NOT NULL FIRST;
ALTER TABLE poems_tmp 
ADD column poems_id INT AUTO_INCREMENT PRIMARY KEY FIRST;

select concat('A', author,'A') from poems_tmp t  where author_id =0;
UPDATE poems_tmp SET author = REPLACE(author, '\n', '')
where author LIKE '\n%';
UPDATE poems_tmp SET author = REPLACE(author, '\n', '')
where author LIKE '%\n';
UPDATE `poems_tmp` 
   SET `author` = TRIM(BOTH FROM `author`);

UPDATE poems_tmp t
INNER JOIN authors a ON  a.full_name = t.author
SET t.author_id = a.author_id;
select * from poems_tmp where translator1_id is null;
select poems_id, author from poems_tmp t  where author_id =0; 
#poemsSQL
update poems_tmp set author_id = 96 where poems_id in (23, 24); #konfuci
update poems_tmp set author_id = 419 where poems_id in (35); # ЮЭФУ (эпоха Хань 206 до н. э. - 220 н. э.)
update poems_tmp set author_id = 405 where poems_id in (87); #ШЭНЬ ЮЭ(441-513)
update poems_tmp set author_id = 419 where poems_id in (1,2,3,4,5,6,7); # ЮЭФУ (эпоха Хань 206 до н. э. - 220 н. э.)
update poems_tmp set author_id = 380 where poems_id in (160,161); #ЧУ ГУАНСИ(707-760?)
update poems_tmp set author_id = 47 where poems_id in (224,225); #'ВЭНЬ ВЭЙ (эпоха Тан)'
update poems_tmp set author_id = 389 where poems_id in (543); #ЧЭНЬ ШИНЮЙ (эпоха Мин)
update poems_tmp set author_id = 359 where poems_id in (226); #ЧЖАН ЯНЬ (эпоха Тан)
update poems_tmp set author_id = 320 where poems_id in (314,315); #ЦЗЯ ДАО(779-843)
update poems_tmp set author_id = 75 where poems_id in (324,325,326); #ДУ МУ(803-852)
#poemsSQL2
update poems_tmp set author_id = 405 where author='ШЭНЬ ЮЭ(441-513)'; #ШЭНЬ ЮЭ(441-513)
update poems_tmp set author_id = 15 where author='ВАН ВЭЙ (699-759)'; #'ВАН ВЭЙ (699-759)'
update poems_tmp set author_id = 419 where author='ЮЭФУ (эпоха Хань 206 до н. э. - 220 н. э.)'; # ЮЭФУ (эпоха Хань 206 до н. э. - 220 н. э.)
update poems_tmp set author_id = 75 where poems_id in (871,872,873); #ДУ МУ(803-852)
update poems_tmp set author_id = 75 where author='АНОНИМНЫЕ РОМАНСЫ из романа “Цзинь, Пин, Мэй” (XVI в.)'; #АНОНИМНЫЕ РОМАНСЫ из романа “Цзинь, Пин, Мэй” (XVI в.)

select * from authors where full_name like 'ЮЭФУ %';
select * from authors where full_name like 'ВАН ВЭЙ%';
select * from authors where full_name like 'ШЭНЬ ЮЭ%';
select author_id,full_name from authors where full_name like '%ЧЭНЬ ШИНЮЙ%';
select * from authors where full_name like 'ШЭНЬ ЮЭ%';
select * from authors where full_name like 'АНОНИМНЫЕ РОМАНСЫ из романа %';
select poems_id, author from poems_tmp t  where author_id =0; #finalcheck

ALTER TABLE poems_tmp drop column author;

INSERT INTO poems (author_id, translator1_id, translator2_id, translator3_id, topic1_id, topic2_id, topic3_id,
topic4_id, topic5_id, cycle_zh, cycle_ru, poem_name_zh, poem_name_ru, poem_code, biblio_id, poem_text)
  SELECT author_id, translator1_id, translator2_id, translator3_id, topic1_id, topic2_id, topic3_id,
topic4_id, topic5_id, cycle_name_zh, cycle_name_ru, poem_name_zh, poem_name_ru, poem_code, biblio_id, poem_text FROM poems_tmp ;

select count(*) from poems;

insert into translators (full_name, real_name, present) Values ('неизвестен', 'неизвестен',1);
insert into biblio (author, book_name, present, ref_name, biblio_name) Values ('неизвестен', 'неизвестен',1,'неизвестен','неизвестен');


CREATE TABLE IF NOT EXISTS tmp (
	poem_name_ru  TEXT NOT NULL,
    poem_code VARCHAR(12)  DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;
LOAD DATA
    INFILE '/Users/alex/site/sql/correction.sql'
    INTO TABLE tmp
	FIELDS TERMINATED BY '#!#'
    LINES TERMINATED BY '\n';
update poems p
inner join  tmp t
on t.poem_name_ru = p.poem_name_ru
set p.poem_code =t.poem_code;

update poems p
set p.poem_code = null 
where p.poem_code ='NULL';
update poems p
set p.poem_code = null 
where p.poem_code ='';

CREATE TABLE IF NOT EXISTS poems_tmp (
    -- poems_id INT AUTO_INCREMENT PRIMARY KEY,
    author VARCHAR(100) NOT NULL,
    translator1_id INT DEFAULT NULL,
    topic1_id INT DEFAULT NULL,
    topic2_id INT DEFAULT NULL,
    topic3_id INT DEFAULT NULL,
    cycle_name_zh VARCHAR(100)  DEFAULT NULL,
    cycle_name_ru  TEXT DEFAULT NULL,
	subcycle_name_zh VARCHAR(100)  DEFAULT NULL,
    subcycle_name_ru  TEXT DEFAULT NULL,
    poem_name_zh VARCHAR(100)  DEFAULT NULL,
    poem_name_ru  TEXT NOT NULL,
    poem_code VARCHAR(12)  DEFAULT NULL,
    biblio_id INT  DEFAULT NULL,
    poem_text MEDIUMTEXT
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;


LOAD DATA
    INFILE '/Users/alex/site/sql/poems4.sql'
    INTO TABLE poems_tmp
	FIELDS TERMINATED BY '#!#'
    OPTIONALLY ENCLOSED BY '^'
    LINES TERMINATED BY '##!!##';

select author_id from poems where author_id like '\n%';
UPDATE poems_tmp SET author = REPLACE(author, '\n', '')
where author LIKE '\n%';
UPDATE poems_tmp SET author = REPLACE(author, '\n', '')
where author LIKE '%\n';
UPDATE `poems_tmp` 
   SET `author` = TRIM(BOTH FROM `author`);

INSERT INTO poems (author_id, translator1_id,  topic1_id, topic2_id, topic3_id,
cycle_zh, cycle_ru, subcycle_zh, subcycle_ru, poem_name_zh, poem_name_ru, poem_code, biblio_id, poem_text)
  SELECT author, translator1_id, topic1_id, topic2_id, topic3_id,
cycle_name_zh, cycle_name_ru, subcycle_name_zh, subcycle_name_ru, poem_name_zh, poem_name_ru, poem_code,
 biblio_id, poem_text FROM poems_tmp ;

#check empty fields
SELECT * FROM poems WHERE '' IN (translator1_id, translator2_id, translator3_id, topic1_id, topic2_id, topic3_id,
topic4_id, topic5_id, cycle_zh, cycle_ru, poem_name_zh, poem_name_ru, poem_code, biblio_id, poem_text);

select poems_id, poem_name_ru from poems where author_id =0 order by poems_id asc;

update poems set author_id = 262 where poems_id in (2619,2620,2621,2622,2623,2624,2625,2626);
update poems set author_id = 124 where poems_id in (2627);
update poems set author_id = 419 where poems_id in (2631,2632,2633,2634,2635,2636,2637,2638,2639,2640,2641,2642,2643,2644,2645,2646,2647,2648,2649,2650,2651,2652,2653,2654,2655,2656,2657,2658,2659,2660,2661,2662,2663,2664,2665,2666,2667,2668,2669,2670,2671,2672,2673,2674,2675,2676,2677,2678);
update poems set author_id = 247 where poems_id in (2679,2680,2681,2682,2683,2684,2685,2686,2687,2688,2689,2690,2691,2692,2693,2694);
update poems set author_id = 312 where poems_id in (2628, 2629, 2630);

SELECT * FROM poems WHERE '0' IN (translator1_id, translator2_id, translator3_id, topic1_id, topic2_id, topic3_id,
topic4_id, topic5_id, cycle_zh, cycle_ru, poem_name_zh, poem_name_ru, poem_code, biblio_id, poem_text);

SELECT * FROM poems WHERE cycle_zh like ' %' or  cycle_ru  like ' %' or
 poem_name_zh like ' %' or  poem_name_ru like ' %';
CREATE TABLE IF NOT EXISTS poems_tmp (
    -- poems_id INT AUTO_INCREMENT PRIMARY KEY,
    author VARCHAR(200) NOT NULL,
    translator1_id INT DEFAULT NULL,
    translator2_id INT DEFAULT NULL,
    translator3_id INT DEFAULT NULL,
    topic1_id INT DEFAULT NULL,
    topic2_id INT DEFAULT NULL,
    topic3_id INT DEFAULT NULL,
    cycle_name_zh VARCHAR(100)  DEFAULT NULL,
    cycle_name_ru  TEXT DEFAULT NULL,
    subcycle_name_zh VARCHAR(100)  DEFAULT NULL,
    subcycle_name_ru  TEXT DEFAULT NULL,
    poem_name_zh VARCHAR(100)  DEFAULT NULL,
    poem_name_ru  TEXT NOT NULL,
    poem_code VARCHAR(12)  DEFAULT NULL,
    biblio_id INT  DEFAULT NULL,
    poem_text MEDIUMTEXT
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;


LOAD DATA
    INFILE '/Users/alex/site/sql/poems6.sql'
    INTO TABLE poems_tmp
	FIELDS TERMINATED BY '#!#'
    OPTIONALLY ENCLOSED BY '^'
    LINES TERMINATED BY '##!!##';

select * from poems where poem_name_ru like '%Плавно%';
drop table poems_tmp;
select * from poems_tmp where translator1_id is null;
delete from poems_tmp where poems_id = 124;
update poems_tmp
set translator1_id=128 where  poems_id=41;
select * from translators;
UPDATE poems_tmp t
INNER JOIN authors a ON  a.full_name = t.author
SET t.author_id = a.author_id;


alter table poems_tmp
add column poem_hash char(32) unique;

update poems_tmp 
set poem_hash = MD5(poem_text);
  SELECT author_id, translator1_id, translator2_id, translator3_id, topic1_id, topic2_id, topic3_id,
cycle_name_zh, cycle_name_ru, subcycle_name_zh, subcycle_name_ru, poem_name_zh, poem_name_ru, poem_code, biblio_id, poem_text, poem_hash 
FROM poems_tmp where poem_hash not in (select poem_hash from poems);

select * from poems_tmp where poem_hash= 'e21f0d1caead5e1e254f38c908a9d38a';
select * from poems where cycle_ru like '%Удивительные истории нашего времени и древности%';
delete from poems_tmp where poems_id=10;
select * from poems_tmp where author_id =312;
INSERT INTO poems (author_id, translator1_id, translator2_id, translator3_id, topic1_id, topic2_id, topic3_id,
cycle_zh, cycle_ru, subcycle_zh, subcycle_ru, poem_name_zh, poem_name_ru, poem_code, biblio_id, poem_text, poem_hash)
  SELECT author_id, translator1_id, translator2_id, translator3_id, topic1_id, topic2_id, topic3_id,
cycle_name_zh, cycle_name_ru, subcycle_name_zh, subcycle_name_ru, poem_name_zh, poem_name_ru, poem_code, biblio_id, poem_text, poem_hash 
FROM poems_tmp where poem_hash not in (select poem_hash from poems);

delete from poems_tmp where poems_id in (1,2,3,4,5,6,7,8,12);

select max(poems_id) from poems limit 0,3000;
select count(*) from originals;
select poem_name_ru from poems limit 0,3000;
select * from translators;
select * from authors;
select poem_name_zh, poem_name_ru from poems where author_id=113;

UPDATE poems SET poem_code = REPLACE(poem_code, '&nbsp;', '')
where poem_code LIKE '&nbsp;%';
UPDATE poems SET poem_name_ru = REPLACE(poem_name_ru, '&nbsp;', '')
where poem_name_ru LIKE '&nbsp;%';
UPDATE poems SET cycle_ru = REPLACE(cycle_ru, '&nbsp;', '')
where cycle_ru LIKE '&nbsp;%';
UPDATE poems SET subcycle_ru = REPLACE(subcycle_ru, '&nbsp;', '')
where subcycle_ru LIKE '&nbsp;%';

alter table poems add index authors_ind(author_id);
alter table poems add index translators_ind(translator1_id,translator2_id);
alter table poems add index topics_ind(topic1_id,topic2_id,topic3_id,topic4_id,topic5_id);
alter table poems add index cycle_ind(cycle_ru(100));
alter table poems add index subcycle_ind(subcycle_ru(100));
alter table poems add index poem_name_ind(poem_name_ru(100));
alter table poems add index poem_name_both_ind(poem_name_zh(100), poem_name_ru(100));
CREATE FULLTEXT INDEX poems_ft_ind ON poems (cycle_zh,cycle_ru,subcycle_zh,subcycle_ru,poem_name_zh, poem_name_ru,poem_text);
alter table authors add  index proper_name_ind (proper_name);
alter table authors add  index epoch_ind (epoch);

CREATE FULLTEXT INDEX authors_ft_ind ON authors (full_name, proper_name, dates, epoch);
alter table originals add  index author_ind (author_id);
alter table originals add  index code_ind (poem_code);
CREATE FULLTEXT INDEX originals_ft_ind ON originals (poem_text);
alter table poems add index poem_code_ind(poem_code);

alter table authors
drop column doc_text;

CREATE TABLE IF NOT EXISTS desc_tmp (
    -- poems_id INT AUTO_INCREMENT PRIMARY KEY,
    author VARCHAR(200) NOT NULL,
    doc_text MEDIUMTEXT
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;

LOAD DATA
    INFILE '/Users/alex/site/sql/authors_desc.sql'
    INTO TABLE desc_tmp
	FIELDS TERMINATED BY '#!#'
    OPTIONALLY ENCLOSED BY '^'
    LINES TERMINATED BY '##!!##';

ALTER TABLE desc_tmp 
ADD column author_id INT NOT NULL FIRST;
ALTER TABLE desc_tmp 
ADD column desc_id INT AUTO_INCREMENT PRIMARY KEY FIRST;

UPDATE desc_tmp SET author = REPLACE(author, '\n', '')
where author LIKE '\n%';
UPDATE desc_tmp SET author = REPLACE(author, '\n', '')
where author LIKE '%\n';
UPDATE `desc_tmp` 
   SET `author` = TRIM(BOTH FROM `author`);

UPDATE desc_tmp t
INNER JOIN authors a ON  a.full_name = t.author
SET t.author_id = a.author_id;

update desc_tmp set author_id = 419 where desc_id=5; 
update desc_tmp set author_id = 47 where desc_id=88; #'ВЭНЬ ВЭЙ (эпоха Тан)'
update desc_tmp set author_id = 389 where desc_id=197; #ЧЭНЬ ШИНЮЙ (эпоха Мин)
update desc_tmp set author_id = 359 where desc_id=89; #ЧЖАН ЯНЬ (эпоха Тан)
update desc_tmp set author_id = 15 where desc_id=106; #ВАН ВЭЙ (699–759)
update desc_tmp set author_id = 2 where desc_id=241; #

select * from desc_tmp where author_id=0;


alter table desc_tmp
drop column author;
select * from authors where full_name like 'ВАН ВЭЙ%'; #15
select * from authors where full_name like 'АНОНИМНЫЕ РОМАНСЫ%'; #2

UPDATE desc_tmp SET doc_text = REPLACE(doc_text, '\t', '');

RENAME TABLE desc_tmp TO a_description;

alter table a_description add index authors_ind(author_id);
CREATE FULLTEXT INDEX desc_text_ind ON a_description (doc_text);

UPDATE poems SET poem_text = REPLACE(poem_text, ' class="NormalWeb"', '');
select poem_text from poems;
update poems 
set poem_hash = MD5(poem_text);

select poem_text from poems where poem_text RLIKE '\n<p class="a22">.+<\/p>'; #2888
select poem_text from poems where poem_text RLIKE '<p class="a22">.+<\/p>'; #29

UPDATE poems SET poem_text = REGEXP_REPLACE(poem_text, '\n<p class="a22">.+<\/p>', '')  
where poem_text like '\n<p class="a22"%'; #2859

UPDATE poems SET poem_text = REGEXP_REPLACE(poem_text, '<p class="a22">.+<\/p>', '')  
where poem_text RLIKE '<p class="a22">.+<\/p>'; #

UPDATE poems SET poem_text = REGEXP_REPLACE(poem_text, '<p class="a22"><\/p>', '')  
where poem_text RLIKE '<p class="a22">.+<\/p>'; #

select poems_id, author_id, poem_text from poems where poem_text like '%<p class="a22"%';

CREATE TABLE IF NOT EXISTS authors_atrib (
    -- atrib_id INT AUTO_INCREMENT PRIMARY KEY,
    author_id INT NOT NULL,
    palladian  VARCHAR(100) DEFAULT NULL,
    zh_trad  VARCHAR(100) DEFAULT NULL,
    zh_simple  VARCHAR(100) DEFAULT NULL,
    pinyin  VARCHAR(100) DEFAULT NULL,
    real_name  VARCHAR(100) DEFAULT NULL,
    real_name_zh  VARCHAR(100) DEFAULT NULL,
    real_name_simple  VARCHAR(100) DEFAULT NULL,
    real_name_pinyin  VARCHAR(100) DEFAULT NULL,
    second_name  VARCHAR(100) DEFAULT NULL,
    second_name_zh  VARCHAR(100) DEFAULT NULL,
    second_name_simple  VARCHAR(100) DEFAULT NULL,
    second_name_pinyin  VARCHAR(100) DEFAULT NULL,
    postmortem_name  VARCHAR(100) DEFAULT NULL,
    postmortem_name_zh  VARCHAR(100) DEFAULT NULL,
    postmortem_name_simple  VARCHAR(100) DEFAULT NULL,
    postmortem_name_pinyin  VARCHAR(100) DEFAULT NULL,
    pseudonim_name  VARCHAR(100) DEFAULT NULL,
    pseudonim_name_zh  VARCHAR(100) DEFAULT NULL,
    pseudonim_name_simple  VARCHAR(100) DEFAULT NULL,
    pseudonim_name_pinyin  VARCHAR(100) DEFAULT NULL,
    nickname  VARCHAR(100) DEFAULT NULL,
    nickname_zh  VARCHAR(100) DEFAULT NULL,
    nickname_simple  VARCHAR(100) DEFAULT NULL,
    nickname_pinyin  VARCHAR(100) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;

 
LOAD DATA  INFILE '/Users/alex/site/sql/authorsAtrib.sql' 
INTO TABLE authors_atrib CHARACTER SET utf8mb4 
FIELDS TERMINATED BY '#!#'     
LINES TERMINATED BY '\n';

ALTER TABLE authors_atrib 
ADD column atrib_id INT AUTO_INCREMENT PRIMARY KEY FIRST;

ALTER TABLE authors_atrib 
ADD column forsearch VARCHAR(1000) DEFAULT NULL;

UPDATE authors_atrib
set forsearch = concat(`palladian`,' ',`zh_trad`,' ',`zh_simple`,' ',`pinyin`,' ',`real_name`,' ',`real_name_zh`,' ',`real_name_simple`,' ',`real_name_pinyin`,' ',`second_name`,' ',`second_name_zh`,' ',`second_name_simple`,' ',`second_name_pinyin`,' ',`postmortem_name`,' ',`postmortem_name_zh`,' ',`postmortem_name_simple`,' ',`postmortem_name_pinyin`,' ',`pseudonim_name`,' ',`pseudonim_name_zh`,' ',`pseudonim_name_simple`,' ',`pseudonim_name_pinyin`,' ',`nickname`,' ',`nickname_zh`,' ',`nickname_simple`,' ',`nickname_pinyin`);
select forsearch from authors_atrib;
alter table authors_atrib add index authors_ind(author_id);
CREATE FULLTEXT INDEX authors_atrib_ind ON authors_atrib (forsearch);

UPDATE a_description SET doc_text = REPLACE(doc_text, '\n', '')
where doc_text LIKE '\n%';
UPDATE a_description SET doc_text = REGEXP_REPLACE(doc_text, 'src="images/', 'src="/images/')  
where doc_text RLIKE 'src="images/'; #216

UPDATE originals SET poem_text = REGEXP_REPLACE(poem_text, '<p class="a39">', '<p>')  
where poem_text RLIKE '<p class="a39">'; #
UPDATE originals SET poem_text = REGEXP_REPLACE(poem_text, '<p class="NormalWeb">', '<p>')  
where poem_text RLIKE '<p class="NormalWeb">'; #

CREATE TABLE IF NOT EXISTS translators_desc (
    translator_id  INT NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    dates VARCHAR(50) DEFAULT NULL,
    summary VARCHAR(250) DEFAULT NULL,
    img VARCHAR(150) DEFAULT NULL,
    doc_text MEDIUMTEXT DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;

LOAD DATA  INFILE '/Users/alex/site/sql/translators.sql' 
INTO TABLE translators_desc CHARACTER SET utf8mb4 
FIELDS TERMINATED BY '#!#'     
LINES TERMINATED BY '##!!##';

ALTER TABLE translators_desc 
ADD column record_id INT AUTO_INCREMENT PRIMARY KEY FIRST;

update  translators_desc set full_name = 'Неизвестен', translator_id=128 where record_id=128;
select * from translators_desc where dates='NULL';
update  translators_desc set dates = null where   dates='NULL';
update  translators_desc set summary = null where   summary='NULL';
update  translators_desc set img = null where   img='NULL';
update  translators_desc set doc_text = null where   doc_text='NULL';
UPDATE translators_desc SET doc_text = REPLACE(doc_text, '\n', '')
where doc_text LIKE '\n%';
UPDATE translators_desc SET doc_text = REPLACE(doc_text, '\n', '')
where doc_text LIKE '%\n';
UPDATE `translators_desc` 
   SET `doc_text` = TRIM(BOTH FROM `doc_text`);
update  translators_desc set doc_text = null where   doc_text='<p></p>';
UPDATE translators_desc SET doc_text = REPLACE(doc_text, '<p>&nbsp;</p>', '')
where doc_text LIKE '<p>&nbsp;</p>%';
select * from translators_desc where doc_text not like '<p class="t22">%';
UPDATE translators_desc SET doc_text = null
where doc_text = '';

CREATE FULLTEXT INDEX desc_text_ind ON translators_desc (full_name,dates,summary,doc_text);

CREATE TABLE IF NOT EXISTS mistakes (
	id INT AUTO_INCREMENT PRIMARY KEY,
    url VARCHAR(200) NOT NULL,
    mistake VARCHAR(2500) NOT NULL,
    comments VARCHAR(2500) DEFAULT NULL,
    ip VARCHAR(15) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE utf8_general_ci;

INSERT INTO mistakes (mistake, ip, url)
VALUES ('example', '90.125.218.173', 'http://chinese-poetry.ru/poems.php?action=show&record_id=337&poem_id=37');

alter table mistakes add index mistake_ind(mistake(200));
alter table mistakes add index url_ind(url);
alter table mistakes add index ip_ind(ip);

select * from authors where full_name like 'ЦЗЕ СИСЫ%';
update authors SET dates = REGEXP_REPLACE(dates, '–', '-'), full_name = REGEXP_REPLACE(full_name, '–', '-') 
where dates  RLIKE '(.*–.*)';
update authors SET dates = REGEXP_REPLACE(dates, ' -', '-'), full_name = REGEXP_REPLACE(full_name, ' -', '-') 
where dates  RLIKE '(.* +-.*)';
update authors SET dates = REGEXP_REPLACE(dates, '- ', '-'), full_name = REGEXP_REPLACE(full_name, '- ', '-') 
where dates  RLIKE '(.*- +.*)';
update authors SET dates = REGEXP_REPLACE(dates, 'н\.э\.', 'н\. э\.'), full_name = REGEXP_REPLACE(full_name, 'н\.э\.', 'н\. э\.') 
where dates  RLIKE '(.*н\.э\..*)';

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЛАО-ЦЗЫ%';
update desc_tmp set author_id=101 where desc_id =1;
update authors set full_name = 'ЛАО-ЦЗЫ (VI-V вв. до н. э.)', dates='(VI-V вв. до н. э.)' where author_id=101; 

select author_id, full_name from authors where full_name like 'КНИГА%';
update desc_tmp set author_id=95 where desc_id =3;

select author_id, full_name from authors where full_name like 'ДЕВЯТНАДЦАТЬ%';
update desc_tmp set author_id=73 where desc_id =4;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЮЭФУ %';
update desc_tmp set author_id=419 where desc_id =5;
update authors set full_name = 'ЮЭФУ (206 до н. э. - 220 н. э.)', dates='(206 до н. э. - 220 н. э.)' where author_id=419; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЦЮЙ ЮАНЬ%';
update desc_tmp set author_id=337 where desc_id =6;
update authors set full_name = 'ЦЮЙ ЮАНЬ (340?-278 до н. э.)', dates='(340?-278 до н. э.)' where author_id=337; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'СУН ЮЙ%';
update desc_tmp set author_id=206 where desc_id =7;
update authors set full_name = 'СУН ЮЙ (III в. до н. э.)', dates='(III в. до н. э.)' where author_id=206; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЦЗЯ И%';
update desc_tmp set author_id=321 where desc_id =8;
update authors set full_name = 'ЦЗЯ И (201-169 до н. э.)', dates='(201-169 до н. э.)' where author_id=321; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ХУАЙНАНЬ СЯОШАНЬ%';
update desc_tmp set author_id=287 where desc_id =9;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЛЮ ЧЖЭНЬ%';
update desc_tmp set author_id=152 where desc_id =13;
update authors set full_name = 'ЛЮ ЧЖЭНЬ (170?-217)', dates='(170?-217)' where author_id=152; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ГУ КАЙЧЖИ%';
update desc_tmp set author_id=57 where desc_id =31;
update authors set full_name = 'ГУ КАЙЧЖИ (344?-406)', dates='(344?-406)' where author_id=57; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'БАО ЧЖАО%';
update desc_tmp set author_id=5 where desc_id =34;
update authors set full_name = 'БАО ЧЖАО (414?-466)', dates='(414?-466)' where author_id=5; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЖЭНЬ ФАН %';
update desc_tmp set author_id=85 where desc_id =39;
update authors set full_name = 'ЖЭНЬ ФАН (460-508)', dates='(460-508)' where author_id=85; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ВЭЙ ЧЭНЦИН %';
update desc_tmp set author_id=45 where desc_id =60;
update authors set full_name = 'ВЭЙ ЧЭНЦИН (640?-707?)', dates='(640?-707?)' where author_id=45; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЛУ ЦЗУНЬ %';
update desc_tmp set author_id=131 where desc_id =62;
update authors set full_name = 'ЛУ ЦЗУНЬ (708?)', dates='(708?)' where author_id=131; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ХАНЬШАНЬ-ЦЗЫ %';
update desc_tmp set author_id=283 where desc_id =65;
update authors set full_name = 'ХАНЬШАНЬ-ЦЗЫ (конец VII - начало VIII вв.)', dates='(конец VII - начало VIII вв.)' where author_id=283; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'БО СИНЦЗЯНЬ %';
update desc_tmp set author_id=6 where desc_id =83;
update authors set full_name = 'БО СИНЦЗЯНЬ (770?-816?)', dates='(770?-816?)' where author_id=6; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЛЮ ЦЗУНЪЮАНЬ%';
update desc_tmp set author_id=147 where desc_id =85;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ВЭНЬ ВЭЙ%';
update desc_tmp set author_id=47 where desc_id =88;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЧЖАН ЯНЬ%';
update desc_tmp set author_id=359 where desc_id =89;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЛЮ ЮЙСИ %';
update desc_tmp set author_id=155 where desc_id =90;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ВЭЙ ИНЪУ%';
update desc_tmp set author_id=43 where desc_id =91;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ВАН ЧЖИХУАНЬ %';
update desc_tmp set author_id=35 where desc_id =104;
update authors set full_name = 'ВАН ЧЖИХУАНЬ (688-742)', dates='(688-742)' where author_id=35; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЛУ ЧЖУАНЬ%';
update desc_tmp set author_id=135 where desc_id =107;
update authors set full_name = 'ЛУ ЧЖУАНЬ (конец VII - начало VIII в.)', dates='(конец VII - начало VIII в.)' where author_id=135; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЛЮ ЧАНЦИН%';
update desc_tmp set author_id=151 where desc_id =110;
update authors set full_name = 'ЛЮ ЧАНЦИН (709?-780?)', dates='(709?-780?)' where author_id=151; 

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'СЫКУН ТУ%';
update desc_tmp set author_id=210 where desc_id =141;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЯНЬ ШУ%';
update desc_tmp set author_id=428 where desc_id =144;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'ЧЖАН ЛЭЙ%';
update desc_tmp set author_id=345 where desc_id =154;

select * from desc_tmp where author_id=0;
select author_id, full_name from authors where full_name like 'СУ ШИ%';
update desc_tmp set author_id=201 where desc_id =158;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name from authors where full_name like 'ЧЭНЬ ШИДАО%';
update desc_tmp set author_id=382 where desc_id =159;
update authors set full_name = 'ЧЭНЬ ШИДАО (1053-1102)', proper_name='Чэнь Шидао' where author_id=382; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЛИ ЦИНЧЖАО%';
update desc_tmp set author_id=113 where desc_id =165;
update authors set full_name = 'ЛИ ЦИНЧЖАО (1084-1151?)', dates='(1084-1151?)' where author_id=113; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЧЖАО ШИСЮ%';
update desc_tmp set author_id=363 where desc_id =177;
update authors set full_name = 'ЧЖАО ШИСЮ (1170?-1225?)', dates='(1170?-1225?)' where author_id=363; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЦЮЙ ЮЙЧЖИ%';
update desc_tmp set author_id=338 where desc_id =178;
update authors set full_name = 'ЦЮЙ ЮЙЧЖИ (1200?)', dates='(1200?)' where author_id=338; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ДАЙ ФУГУ%';
update desc_tmp set author_id=70 where desc_id =179;
update authors set full_name = 'ДАЙ ФУГУ (1167-1248)', dates='(1167-1248)' where author_id=70; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЧЭНЬ ЮАНЬПИН%';
update desc_tmp set author_id=390 where desc_id =184;
update authors set full_name = 'ЧЭНЬ ЮАНЬПИН (1240?)', dates='(1240?)' where author_id=390; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'БО ПУ%';
update desc_tmp set author_id=3 where desc_id =193;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЧЭНЬ ШИНЮЙ%';
update desc_tmp set author_id=389 where desc_id =197;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ДЭН ГУАНЦЗЯНЬ%';
update desc_tmp set author_id=81 where desc_id =198;
update authors set full_name = 'ДЭН ГУАНЦЗЯНЬ (1270?)', dates='(1270?)' where author_id=81; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЛО ГУАНЬЧЖУН%';
update desc_tmp set author_id=124 where desc_id =212;
update authors set full_name = 'ЛО ГУАНЬЧЖУН (1330—1400)', dates='(1330—1400)' where author_id=124; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ВАН ГУН%';
update desc_tmp set author_id=18 where desc_id =225;
update authors set full_name = 'ВАН ГУН (1398?-?)', dates='(1398?-?)' where author_id=18; 


select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ВАН ВЭЙ%';
update desc_tmp set author_id=16 where desc_id =227;
update authors set full_name = 'ВАН ВЭЙ (конец XIV - начало XV вв.)', dates='(конец XIV - начало XV вв.)' where author_id=16; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'У ЧЭНЪЭНЬ%';
update desc_tmp set author_id=256 where desc_id =242;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ВАН ВЭЙ%';
update desc_tmp set author_id=16 where desc_id =227;
update authors set full_name = 'ВАН ВЭЙ (конец XIV - начало XV вв.)', dates='(конец XIV - начало XV вв.)' where author_id=16; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЛИ ПАНЬЛУН%';
update desc_tmp set author_id=107 where desc_id =243;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ВАН ШИЧЖЭНЬ %';
update desc_tmp set author_id=38 where desc_id =244;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЧЭН ЦЗЯСУЙ%';
update desc_tmp set author_id=381 where desc_id =247;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ФЫН МЭН-ЛУН (1576-1646)%';
update desc_tmp set author_id=267 where desc_id =250;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ФАН ВЭЙИ (1585-1668)%';
update desc_tmp set author_id=258 where desc_id =251;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЦЗИНЬ ГУ ЦИГУАНЬ (первая половина XVII в.)%';
update desc_tmp set author_id=312 where desc_id =252;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЦЗИНЬ ЧЖУН (XVII в.)%';
update desc_tmp set author_id=314 where desc_id =253;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ФУ ВАНЬЧУНЬ (1631-1647)%';
select * from desc_tmp where author like 'ФУ ВАН%';
update desc_tmp set author_id=264 where desc_id =269;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'СУН ДЭНЧУНЬ%';
update desc_tmp set author_id=202 where desc_id =272;
select * from authors  where author_id=16;
select * from authors  where full_name like 'СУН ДЭНЧУНЬ%';
update authors set full_name = 'СУН ДЭНЧУНЬ (1633-?)', dates='(1633-?)' where author_id=202; 

update authors set full_name = 'ВАН ВЭЙ (конец XIV - начало XV вв.)', dates='(конец XIV - начало XV вв.)' where author_id=16; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ХАНЬ СЯ%';
update desc_tmp set author_id=275 where desc_id =274;
update authors set full_name = 'ХАНЬ СЯ (1644-?)', dates='(1644-?)' where author_id=275; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ВАН ХУН%';
update desc_tmp set author_id=27 where desc_id =275;
update authors set full_name = 'ВАН ХУН (1644?)', dates='(1644?)' where author_id=27; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЮЙ ХУАНХАО%';
update desc_tmp set author_id=416 where desc_id =278;
update authors set full_name = 'ЮЙ ХУАНХАО (1700?)', dates='(1700?)' where author_id=416; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'СУН ЛИНЪЮНЬ%';
update desc_tmp set author_id=203 where desc_id =279;
update authors set full_name = 'СУН ЛИНЪЮНЬ (1700?)', dates='(1700?)' where author_id=203; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЖЧУ ЦЗИН%';
update desc_tmp set author_id=84 where desc_id =280;
update authors set full_name = 'ЖЧУ ЦЗИН (1700?)', dates='(1700?)' where author_id=84; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЦАО СЮЭЦИНЬ%';
update desc_tmp set author_id=306 where desc_id =282;
update authors set full_name = 'ЦАО СЮЭЦИНЬ (1724?-1764?)', dates='(1724?-1764?)' where author_id=306; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ЦЗУН БАЙХУА%';
update desc_tmp set author_id=318 where desc_id =304;
update authors set full_name = 'ЦЗУН БАЙХУА (1897-1986)', dates='(1897-1986)' where author_id=318; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ШИ%';
update desc_tmp set author_id=399 where desc_id =363;

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'ХАНЬ%';
update desc_tmp set author_id=282 where desc_id =381;
update authors set full_name = 'ХАНЬ ДУН (1961-ныне)', dates='(1961-ныне)' where author_id=282; 

select * from desc_tmp where author_id=0;
select author_id, full_name, proper_name, dates from authors where full_name like 'НЕИЗВЕСТНЫЕ %';
update desc_tmp set author_id=172 where desc_id =429;

select * from authors where full_name ='ВЭЙ ИНЪУ (737-791?)';
select * from authors where full_name like 'ВЭЙ ИНЪУ%';
update authors set full_name = 'ВЭЙ ИНЪУ (737-791?)', dates='(737-791?)' where author_id=43; 

select * from authors where full_name ='ВЭЙ ЧЭНЦИН (640-706)';
select * from authors where full_name like'ВЭЙ Ч%';
update authors set full_name = 'ВЭЙ ЧЭНЦИН (640-706)', dates='(640-706)' where author_id=45; 

select * from authors where full_name ='ЛО ГУАНЬЧЖУН (1330—1400)';
select * from authors where full_name ='СУН ЮЙ (III в. до н. э.)';
select * from authors where full_name ='ФЫН МЭН-ЛУН (1576-1646)';
select * from authors where full_name ='ЧЖАН ЛЭЙ (1054-1114)';
select * from authors where full_name ='ШИ ЧЖИ (1948-?)';

alter table authors  drop column doc_text;
CREATE TABLE IF NOT EXISTS desc_tmp2 (
    -- poems_id INT AUTO_INCREMENT PRIMARY KEY,
    author_id INT NOT NULL,
    doc_text MEDIUMTEXT
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb4 COLLATE utf8mb4_0900_ai_ci;
select max(length(author)) from desc_tmp;
insert into desc_tmp2 (select author_id, doc_text from desc_tmp  order by author_id);
select * from desc_tmp2;

ALTER TABLE desc_tmp2 
ADD column desc_id INT AUTO_INCREMENT PRIMARY KEY FIRST;


RENAME TABLE desc_tmp2 TO a_description;

drop table desc_tmp;
select * from a_description;

alter table a_description add index authors_ind(author_id);
CREATE FULLTEXT INDEX desc_text_ind ON a_description (doc_text);


update authors set full_name = 'ЛО ГУАНЬЧЖУН (1330-1400)' where author_id = 124;
update authors SET dates = REGEXP_REPLACE(dates, '—', '-'), full_name = REGEXP_REPLACE(full_name, '–', '-') 
where dates  RLIKE '(.*—.*)';
update authors set proper_name = 'Хань Дун' where author_id = 282;
update authors set full_name = 'СУН ЮЙ (298? до н. э - 222? до н. э)', dates = '(298? до н. э - 222? до н. э)';

UPDATE poems SET poem_text = REPLACE(poem_text, 'class="-"', 'class="t22"')
-- select  poems_id, poem_text from poems 
where poem_text RLIKE '<p class="-">' 
and poem_text NOT RLIKE '<p class="-" style';

UPDATE poems SET poem_text = REGEXP_REPLACE(poem_text, '<p  style', '<p style')
-- select  poems_id, poem_text from poems 
where poem_text RLIKE '<p  style';

UPDATE poems SET poem_text = REPLACE(poem_text, '<p class="-">', '<p class="t22">')
where poem_text RLIKE '<p class="-">' 
and poem_text  RLIKE '<p class="-" style'
and poems_id in (40,41,43,609,621,697,726,739,786,817,852,904,908,978,991,1201,2087,2131,2337,2373,2377,2544,2559,2868);

UPDATE poems SET poem_text = REPLACE(poem_text, 'class="-"', '') 
-- where poem_text RLIKE '<p class="-">' 
-- and poem_text  RLIKE '<p class="-" style'
where poems_id in (40,41,43,609,621,697,726,739,786,817,852,904,908,978,991,1201,2087,2131,2337,2373,2377,2544,2559,2868);

UPDATE poems SET poem_text =  REGEXP_REPLACE(poem_text, '<p>&nbsp;</p>$', '') 
-- select poems_id, poem_text from poems
where poem_text RLIKE '<p>&nbsp;</p>$';

UPDATE poems SET poem_text =  REGEXP_REPLACE(poem_text, '<p>&nbsp;</p>\n$', '') 
-- select poems_id, poem_text from poems
where poem_text RLIKE '<p>&nbsp;</p>\n$';

UPDATE poems SET poem_text =  REGEXP_REPLACE(poem_text, '<p class="a5">&nbsp;</p>$', '') 
-- select poems_id, poem_text from poems
where poem_text RLIKE '<p class="a5">&nbsp;</p>$';

UPDATE poems SET poem_text =  REGEXP_REPLACE(poem_text, '<p class="a5">&nbsp;</p>$', '') 
-- select poems_id, poem_text from poems
where poem_text RLIKE '<p class="a5">&nbsp;</p>$';

update poems 
set poem_hash = MD5(poem_text);

select poems_id, poem_text from poems where poem_text RLIKE 'class="-"';
UPDATE poems SET poem_text = REPLACE(poem_text, 'class="-"', '')
-- select poems_id, poem_text from poems 
where poem_text RLIKE 'class="-" style';

#all lines
SELECT 
--    poems_id, poem_text,    
    CHAR_LENGTH(poem_text) - CHAR_LENGTH(REPLACE(poem_text, '</p>', SPACE(LENGTH('</p>')-1))) 
        AS `count`    
FROM poems where poems_id=2778; #35

#regular lines
SELECT 
--    poems_id, poem_text,    
    CHAR_LENGTH(poem_text) - CHAR_LENGTH(REPLACE(poem_text, '<p>', SPACE(LENGTH('<p>')-1))) 
        AS `count`    
FROM poems where poems_id=2778; #19

#empty lines
SELECT 
--    poems_id, poem_text,    
    CHAR_LENGTH(poem_text) - CHAR_LENGTH(REGEXP_REPLACE(poem_text, '<p>&nbsp;</p>', SPACE(LENGTH('<p>&nbsp;</p>')-1))) 
        AS `count`    
FROM poems where poems_id=2778; #3

#line with indent
SELECT 
    poems_id, poem_text,    
    CHAR_LENGTH(poem_text) - CHAR_LENGTH(REGEXP_REPLACE(poem_text, '<p style', SPACE(LENGTH('<p style')-1))) 
        AS `count`    
FROM poems where poems_id=786; #3

#line with indent
SELECT 
    poems_id, poem_text,    
    CHAR_LENGTH(poem_text) - CHAR_LENGTH(REGEXP_REPLACE(poem_text, '"t22"', SPACE(LENGTH('"t22"')-1))) 
        AS `count`    
FROM poems where poems_id=786; #16

#line with indent
SELECT 
--    poems_id, poem_text,    
    CHAR_LENGTH(poem_text) - CHAR_LENGTH(REPLACE(poem_text, '<p class="t22"', SPACE(LENGTH('<p class="t22"')-1))) 
        AS `count`    
FROM poems where poems_id=549; #3

alter table poems drop column totallines;
alter table poems drop column fulllines;

alter table poems add column totallines INT default 0;

UPDATE poems SET totallines = (
	(CHAR_LENGTH(poem_text) - CHAR_LENGTH(REPLACE(poem_text, '<p>', SPACE(LENGTH('<p>')-1)))) #lines without indent
+   (CHAR_LENGTH(poem_text) - CHAR_LENGTH(REGEXP_REPLACE(poem_text, '"t22"', SPACE(LENGTH('"t22"')-1)))) #lines wit indent
+   (CHAR_LENGTH(poem_text) - CHAR_LENGTH(REGEXP_REPLACE(poem_text, '<p style', SPACE(LENGTH('<p style')-1)))) #lines with indent
-   (CHAR_LENGTH(poem_text) - CHAR_LENGTH(REPLACE(poem_text, '<p>&nbsp;</p>', SPACE(LENGTH('<p>&nbsp;</p>')-1)))) #spaces
);

alter table poems add column fulllines INT default 0;

UPDATE poems SET fulllines = (
	(CHAR_LENGTH(poem_text) - CHAR_LENGTH(REPLACE(poem_text, '<p>', SPACE(LENGTH('<p>')-1)))) #lines without indent
-- +   (CHAR_LENGTH(poem_text) - CHAR_LENGTH(REGEXP_REPLACE(poem_text, '"t22"', SPACE(LENGTH('"t22"')-1)))) #lines wit indent
-- +   (CHAR_LENGTH(poem_text) - CHAR_LENGTH(REGEXP_REPLACE(poem_text, '<p style', SPACE(LENGTH('<p style')-1)))) #lines with indent
-   (CHAR_LENGTH(poem_text) - CHAR_LENGTH(REPLACE(poem_text, '<p>&nbsp;</p>', SPACE(LENGTH('<p>&nbsp;</p>')-1)))) #spaces
);

select * from poems;
alter table poems add column genres varchar(250) default null;

alter table originals add column genres varchar(250) default null;
alter table originals add column size varchar(250) default null;
SELECT p.poems_id, p.translator1_id, t.full_name, p.translator2_id, p.poem_name_zh, p.poem_name_ru 
FROM poems p
inner join translators t on p.translator1_id = t.translator_id
	    WHERE poem_code = 'ВВ-36' order by t.full_name;
SELECT a.author_id, a.full_name, a.proper_name,  a.dates,  a.epoch, a.present,t.zh_trad,t.zh_simple 
		FROM  authors a  
inner join authors_atrib t on a.author_id = t.author_id
		WHERE a.author_id='3';

UPDATE originals
SET cycle_ru = CONCAT(UCASE(LEFT(cycle_ru, 1)), SUBSTRING(cycle_ru, 2))
 where cycle_ru RLIKE '^[:lower:]' and originals_id !=126;

update originals         
SET cycle_ru = REGEXP_REPLACE(cycle_ru, '$', '"')
-- select * from originals where cycle_ru is not null
 where cycle_ru RLIKE '^[:alpha:]' and originals_id !=126;

update originals         
SET cycle_ru = REGEXP_REPLACE(cycle_ru, '^', '"')
-- select cycle_ru from originals
 where cycle_ru RLIKE '^[:alpha:]' and originals_id !=126;
--- 1. delete all Из цикла 
select distinct cycle_ru from poems
--  where cycle_ru is not null
 where cycle_ru  RLIKE '^Из цикла ';
 
 update poems
 set cycle_ru = REGEXP_REPLACE(cycle_ru, '^Из цикла ', '')
  where cycle_ru  RLIKE '^Из цикла ';
 --- 2. change to upper
 select distinct cycle_ru from poems;
 UPDATE poems
SET cycle_ru = CONCAT(UCASE(LEFT(cycle_ru, 1)), SUBSTRING(cycle_ru, 2));
 --- 3. make in quotes
update poems         
SET cycle_ru = REGEXP_REPLACE(cycle_ru, '$', '"')
-- select distinct cycle_ru from poems
 where cycle_ru RLIKE '^[:alpha:]' and cycle_ru NOT RLIKE '"';


select distinct cycle_ru from poems
 where  cycle_ru RLIKE '^[:alpha:]' and cycle_ru   NOT RLIKE '"[:alpha:]';

update poems         
SET cycle_ru = REGEXP_REPLACE(cycle_ru, '^', '"')
 where  cycle_ru RLIKE '^[:alpha:]' and cycle_ru   NOT RLIKE '"[:alpha:]';

select distinct cycle_ru from poems where cycle_ru RLIKE '\\)';
select poems_id, cycle_ru from poems where cycle_ru like '%сани%';
 SELECT a.author_id, a.full_name, a.proper_name,  a.dates,  a.epoch, a.present, b.zh_trad, b.zh_simple
		FROM  authors a
		INNER JOIN  authors_atrib b ON b.author_id = a.author_id 
		WHERE a.author_id=1;

alter table authors add column zname VARCHAR(100) default null;
UPDATE authors a set zname = null;
UPDATE authors a
INNER JOIN authors_atrib b ON b.author_id = a.author_id 
SET a.zname = b.zh_trad;

UPDATE authors a
INNER JOIN authors_atrib b ON b.author_id = a.author_id 
SET a.zname = b.zh_simple
where zname = '' ;

select full_name, zname from authors where zname <> '';

select full_name, zname from authors;
use poetry;
SELECT `poems_id`,`author_id`,`translator1_id`,`translator2_id`,
	`topic1_id`,`topic2_id`,`topic3_id`,`topic4_id`,`topic5_id`,`cycle_zh`,`cycle_ru`,`subcycle_zh`,
	`subcycle_ru`,`poem_name_zh`,`poem_name_ru`,`poem_code`,`biblio_id`,`poem_text`,`poem_hash`
	 FROM  poems WHERE poems_id =434;
     
SELECT `poems_id`,`author_id`,`translator1_id`,`translator2_id`,
	`topic1_id`,`topic2_id`,`topic3_id`,`topic4_id`,`topic5_id`,`cycle_zh`,`cycle_ru`,`subcycle_zh`,`subcycle_ru`,
	`poem_name_zh`,`poem_name_ru`,`poem_code`,`biblio_id` FROM  poems 
	 WHERE biblio_id =320
	 ORDER BY `author_id`, `translator1_id`, cast(`poem_name_ru` as unsigned),`poem_name_ru`,`cycle_ru`, `subcycle_ru`, `poems_id` ASC;


ALTER TABLE originals ADD site VARCHAR(50) DEFAULT NULL;
ALTER TABLE originals ADD siteURL VARCHAR(250) DEFAULT NULL;
ALTER TABLE poems ADD site VARCHAR(50) DEFAULT NULL;
ALTER TABLE poems ADD siteURL VARCHAR(250) DEFAULT NULL;

CREATE TABLE IF NOT EXISTS selectedpoems (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `poems_id` INT NOT NULL,
    `ip`  varchar(45) NOT NULL,
	`datetime` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	FOREIGN KEY (poems_id) REFERENCES poems(poems_id)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COLLATE utf8_general_ci;

select poems_id, poem_text from poems where poem_text RLIKE ' [\.]{3}';
UPDATE poems SET poem_text = REGEXP_REPLACE(poem_text, ' [\.]{3}', '\.\.\.')  
where poem_text RLIKE ' [\.]{3}'; #

select poems_id, cycle_ru from poems where cycle_ru RLIKE '^Из стихов ';
UPDATE poems SET cycle_ru = REGEXP_REPLACE(cycle_ru, '^Из стихов ', '')  
where cycle_ru RLIKE '^Из стихов '; #
select poems_id, cycle_ru from poems where cycle_ru RLIKE '^Из ';
UPDATE poems SET cycle_ru = REGEXP_REPLACE(cycle_ru, '^Из ', '')  
where cycle_ru RLIKE '^Из '; #
select poems_id, subcycle_ru from poems where subcycle_ru RLIKE '^Из ';

select poems_id, cycle_ru from poems where cycle_ru RLIKE '^Из ';

ALTER TABLE poems add column corder int default null after cycle_ru;
ALTER TABLE poems add column scorder int default null after subcycle_ru;
ALTER TABLE originals add column corder int default null after cycle_ru;
ALTER TABLE originals add column scorder int default null after subcycle_ru;
delete from selectedpoems where poems_id=0;

alter table poetry.biblio add column iframe varchar(200) default null;
CREATE FULLTEXT INDEX poem_text_ft_ind ON poems (poem_name_ru,poem_text);

CREATE TABLE `otherbiblio` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `poems_id` int(11) NOT NULL,
  `main_biblio_id` int(11) NOT NULL,
  `other_biblio_id` int(11) NOT NULL,
  `page`  int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `poems_id` (`poems_id`,`main_biblio_id`,`other_biblio_id`, `page`),
  KEY `main_biblio_ind` (`main_biblio_id`),
  KEY `poems_id_ind` (`poems_id`),
  FOREIGN KEY (poems_id) REFERENCES poems(poems_id)
) ENGINE=MyISAM AUTO_INCREMENT=30 DEFAULT CHARSET=utf8;


alter table poems add column `page` int default null  after biblio_id;
alter table originals add column `page` int default null  after biblio_id;

use poetry;
ALTER TABLE originals MODIFY cycle_zh TEXT;
ALTER TABLE originals MODIFY cycle_ru TEXT;
ALTER TABLE originals MODIFY subcycle_zh TEXT;
ALTER TABLE originals MODIFY subcycle_ru TEXT;
ALTER TABLE originals MODIFY poem_name_zh TEXT;
ALTER TABLE originals MODIFY poem_name_ru TEXT;
ALTER TABLE originals drop index originals_ft_ind;
CREATE FULLTEXT INDEX originals_ft_ind ON originals (poem_text);


SET sql_safe_updates = off;
SET @count = 0;
UPDATE `audio` SET `audio`.`id` = @count:= @count + 1;

use poetry;
CREATE TABLE `audio` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `originals_id` int(11) NOT NULL,
  `url` text  NOT NULL,
  `type` varchar(20) default NULL,
  PRIMARY KEY (`id`),
  KEY `originals_ind` (`originals_id`)
) ENGINE=MyISAM AUTO_INCREMENT=60 DEFAULT CHARSET=utf8;
